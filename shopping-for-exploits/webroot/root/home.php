<?php
  error_reporting(0);
  require_once('conn.php');
	session_start();

  # Needed so users cannot just type in /home.php to access page without logging in
	if(!isset($_SESSION['username']))
	{
		header('location: login.php');
		exit;
	}

  include ("blacklist.php");

  $order = $_POST['price'];

  # Search for blacklisted string in blacklist[]
  # stripos() will match case insensitive, Ex: "or" "OR"
  # If found, boolean set injection to be true
  foreach ($blacklist as $word) {
    if(stripos($order, $word) !== false){
      $injection = true;
      $found = $word;
    }
  }

  $query = "SELECT * FROM NFTArt ";

  # Concatinate the rest of the query based on choice/input
  # $query = "SELECT * FROM NFTArt ORDER BY art_price" + "ASC"
  # $query = "SELECT * FROM NFTArt ORDER BY art_price" + "DESC""
  # $query = "SELECT * FROM NFTArt ORDER BY art_price" + '$order'   <------(injection)

  if ($order == "lowHigh"){
    $query .= "ORDER BY art_price ASC";
  }

  elseif ($order == "highLow"){
    $query .= "ORDER BY art_price DESC";
  }

  # SQL Injection Vulnerability
  # A user can edit from "view source" either lowHigh or highLow, and will execute the above $query
  # Since it is using a varable after a POST action, it will execute whatever $order is
  else{
    $query .= "$order";
  }

  $results = $db->query($query);

  # Feedback on our SQL injection
  if (!$results) {
    echo "<h1><b>SERVER ERROR!</b></h1>";

    # Alert users of injection attempt when the DB just returns an error, don't give any info from DB error
    if($injection){
      echo "<h1><b>SQL Injection Attempted!</b></h1>";
      echo "<h5><b>STRING VALUE: ''" . $found . "'' cannot be queried with!</b></h5>";
    }

    # If DB returns an error but executes query bypassing blacklist, return DB error for enumeration
    else{
      echo $db->lastErrorMsg() . " ";
    }
  }

  # Query returned a result
  else{
    # Alert users of injection attempt when results might be returned
    # Also gives valuable feedback to craft successful injections to bypass blacklisted strings
    if($injection){
      echo "<h1><b>SQL Injection Attempted!</b></h1>";
      echo "<h5><b>STRING VALUE: ' " . $found . " ' cannot be queried with!</b></h5>";
    }

    # Return Proper query with malicious result
    else{

      # Through each iteration of each $row of the query result, assign a value for each row number to display in html
      $i = 1;
      while($row = $results->fetchArray(SQLITE3_ASSOC)) {
        ${"name" . $i} = $row['art_name'];
        ${"price" . $i} = $row['art_price'];
        ${"image" . $i} = 'src="../res/images/'.$row['art_id'].'.png"';
        $i++;
      }
    }
  }

?>

<!DOCTYPE html>

<!--TITLE-->

<html style="font-size: 16px;">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="keywords" content="NFT SHOP">
    <meta name="description" content="">
    <meta name="page_type" content="np-template-header-footer-from-plugin">
    <title>home</title>
    <link rel="stylesheet" href="../res/css/style.css" media="screen">
<link rel="stylesheet" href="../res/css/home.css" media="screen">
    <script class="u-script" type="text/javascript" src="../res/js/jquery.js" defer=""></script>
    <script class="u-script" type="text/javascript" src="../res/js/style.js" defer=""></script>


</script>
    <meta name="theme-color" content="#478ac9">
    <meta property="og:title" content="home">
    <meta property="og:type" content="website">
  </head>

  <body class="u-body"><header class="u-clearfix u-header u-header" id="sec-5a07"><div class="u-clearfix u-sheet u-sheet-1">

      <h1 class="u-align-center u-text u-text-default u-text-1">NFT SHOP</h1>
      <h5 class="u-align-center u-text u-text-default u-text-2">Own a piece of digital art today!</h5>

        <!--LOGOUT BUTTON-->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

        <form align="center" name="form1" method="post" action="log_out.php">
          <button type="submit" class="btn btn-default btn-sm" name="submit2" id="submit2">
            <span class="glyphicon glyphicon-log-out"></span> Log out
          </button>
        </form>
        <!--END LOGOUT BUTTON-->

        <h3 align="center">Hello, <?php echo $_SESSION['username'];?>!</h3>

      </div></header>

<!--END TITLE-->

<!--START FILTER FORM-->

    <section class="u-align-center u-clearfix u-section-1" id="sec-143b">
      <form action="" name="frm" method="post">

              <select name="price" id="price">
                  <option value="lowHigh">Low to High</option>
                  <option value="highLow">High to Low</option>
             </select>

             <input type="submit" name="orderPrice" value="Filter Prices" />

          </form>

<!--END FILTER FORM-->

<!--START NFTS-->
      <div class="u-clearfix u-sheet u-sheet-1">
        <div class="u-expanded-width-md u-expanded-width-sm u-expanded-width-xs u-products u-products-1">
          <div class="u-repeater u-repeater-1">

            <!--NFT 1-->
            <div class="u-align-center-lg u-align-center-sm u-align-center-xl u-align-center-xs u-container-style u-products-item u-repeater-item">
              <div class="u-container-layout u-similar-container u-valign-top-lg u-valign-top-md u-valign-top-xl u-container-layout-1"><!--product_image-->
                <img alt="" class="u-image u-image-default u-product-control u-image-1" <?php echo $image1;?> data-image-width="306" data-image-height="306"><!--/product_image-->
                <div class="u-align-center u-container-style u-group u-palette-5-light-2 u-group-1">
                  <div class="u-container-layout u-container-layout-2"><!--product_title-->
                    <h4 class="u-product-control u-text u-text-1">
                      <a class="u-product-title-link"><!--product_title_content--><?php echo $name1;?><!--/product_title_content--></a>
                    </h4><!--/product_title--><!--product_price-->
                    <div class="u-product-control u-product-price u-product-price-1">
                      <div class="u-price-wrapper u-spacing-10"><!--product_old_price-->

                        <div class="u-price" style="font-size: 1.25rem; font-weight: 700;"><!--product_regular_price_content--><?php echo $price1;?> ETH<!--/product_regular_price_content--></div><!--/product_regular_price-->
                      </div>
                    </div>
                    <a href="" class="u-border-active-none u-border-hover-none u-btn u-btn-rectangle u-button-style u-none u-product-control u-text-palette-1-base u-btn-1"><!--product_button_content-->PLACE BID<!--/product_button_content--></a><!--/product_button-->
                  </div>
                </div><!--product_content-->
              </div>
            </div>
            <!--END NFT1-->

            <!--NFT2-->
            <div class="u-align-center-lg u-align-center-md u-align-center-sm u-align-center-xl u-container-style u-products-item u-repeater-item">
              <div class="u-container-layout u-similar-container u-valign-top u-container-layout-3"><!--product_image-->
                <img alt="" class="u-image u-image-default u-product-control u-image-2" <?php echo $image2;?> data-image-width="306" data-image-height="306"><!--/product_image-->
                <div class="u-align-center u-container-style u-group u-palette-5-light-2 u-group-2">
                  <div class="u-container-layout u-container-layout-4"><!--product_title-->
                    <h4 class="u-product-control u-text u-text-3">
                      <a class="u-product-title-link"><!--product_title_content--><?php echo $name2;?><!--/product_title_content--></a>
                    </h4><!--/product_title--><!--product_price-->
                    <div class="u-product-control u-product-price u-product-price-2">
                      <div class="u-price-wrapper u-spacing-10"><!--product_old_price-->
                        <div class="u-price" style="font-size: 1.25rem; font-weight: 700;"><!--product_regular_price_content--><?php echo $price2;?> ETH<!--/product_regular_price_content--></div><!--/product_regular_price-->
                      </div>
                    </div>
                    <a href="" class="u-border-active-none u-border-hover-none u-btn u-btn-rectangle u-button-style u-none u-product-control u-text-palette-1-base u-btn-2"><!--product_button_content-->PLACE BID<!--/product_button_content--></a><!--/product_button-->
                  </div>
                </div><!--product_content-->
              </div>
            </div>
            <!--END NFT2-->

            <!--NFT3-->
            <div class="u-align-center u-container-style u-products-item u-repeater-item">
              <div class="u-container-layout u-similar-container u-valign-top-lg u-valign-top-md u-valign-top-xl u-container-layout-5"><!--product_image-->
                <img alt="" class="u-image u-image-default u-product-control u-image-3" <?php echo $image3;?> data-image-width="306" data-image-height="306"><!--/product_image-->
                <div class="u-align-center u-container-style u-group u-palette-5-light-2 u-group-3">
                  <div class="u-container-layout u-container-layout-6"><!--product_title-->
                    <h4 class="u-product-control u-text u-text-5">
                      <a class="u-product-title-link"><!--product_title_content--><?php echo $name3;?><!--/product_title_content--></a>
                    </h4><!--/product_title--><!--product_price-->
                    <div class="u-product-control u-product-price u-product-price-3">
                      <div class="u-price-wrapper u-spacing-10"><!--product_old_price-->
                        <div class="u-price" style="font-size: 1.25rem; font-weight: 700;"><!--product_regular_price_content--><?php echo $price3;?> ETH<!--/product_regular_price_content--></div><!--/product_regular_price-->
                      </div>
                    </div>
                    <a href="" class="u-border-active-none u-border-hover-none u-btn u-btn-rectangle u-button-style u-none u-product-control u-text-palette-1-base u-btn-3"><!--product_button_content-->PLACE BID<!--/product_button_content--></a><!--/product_button-->
                  </div>
                </div><!--product_content-->
              </div>
            </div>
            <!--END NFT3-->

            <!--NFT4-->
            <div class="u-align-center u-container-style u-products-item u-repeater-item">
              <div class="u-container-layout u-similar-container u-valign-top u-container-layout-7"><!--product_image-->
                <img alt="" class="u-image u-image-default u-product-control u-image-4" <?php echo $image4;?> data-image-width="306" data-image-height="306"><!--/product_image-->
                <div class="u-align-center u-container-style u-group u-palette-5-light-2 u-group-4">
                  <div class="u-container-layout u-container-layout-8"><!--product_title-->
                    <h4 class="u-product-control u-text u-text-7">
                      <a class="u-product-title-link"><!--product_title_content--> <?php echo $name4;?><!--/product_title_content--></a>
                    </h4><!--/product_title--><!--product_price-->
                    <div class="u-product-control u-product-price u-product-price-4">
                      <div class="u-price-wrapper u-spacing-10"><!--product_old_price-->
                        <div class="u-price" style="font-size: 1.25rem; font-weight: 700;"><!--product_regular_price_content--><?php echo $price4;?> ETH<!--/product_regular_price_content--></div><!--/product_regular_price-->
                      </div>
                    </div>
                    <a href="" class="u-border-active-none u-border-hover-none u-btn u-btn-rectangle u-button-style u-none u-product-control u-text-palette-1-base u-btn-4"><!--product_button_content-->PLACE BID<!--/product_button_content--></a><!--/product_button-->
                  </div>
                </div>
              </div>
            </div>
            <!--END NFT4-->

          </div>
        </div>
        <!--END NFTS-->

      </div>
    </section>
  </body>
</html>
